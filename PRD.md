# Double - 产品需求文档 (PRD)

## 1. 项目背景

### 1.1 问题陈述
- 主流Chatbot应用（如ChatGPT、Claude）需要翻墙使用，国内用户访问困难
- 国内AI应用通常需要云端存储数据，隐私性不足
- 现有工具对技术小白不够友好，配置复杂

### 1.2 解决方案
**Double** 是一款面向技术小白的本地优先AI助手应用，数据完全存储在本地，支持国内主流大模型（DeepSeek、Moonshot），开箱即用。

### 1.3 目标用户
- 国内个人用户，对AI助手有日常需求
- 注重数据隐私，希望对话记录本地存储
- 非技术背景，需要简单易用的界面

---

## 2. 项目目标

### 2.1 核心目标
打造一个**安全、简单、强大**的本地AI助手，让普通用户也能享受AI带来的便利。

### 2.2 成功指标
- [ ] 支持DeepSeek和Moonshot两个国内模型
- [ ] 对话历史100%本地存储（MD/JSON/JSONL格式）
- [ ] 支持AI控制浏览器完成自动化任务
- [ ] 零配置开箱即用

### 2.3 非目标（本期不做）
- 本地大模型部署（仅支持远程API）
- 多用户协作
- 云端同步功能

---

## 3. 项目拆解和实现

### 3.1 技术架构
```
┌─────────────────────────────────────────────┐
│                  Double App                  │
│  (Electron + Vanilla JS / Vue / React)      │
├─────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐          │
│  │ 对话模块    │  │ 浏览器控制  │          │
│  │ (JSONL)     │  │ (Puppeteer) │          │
│  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐          │
│  │ 文件处理    │  │ 设置面板    │          │
│  │ (MD/YAML)   │  │ (JSON)      │          │
│  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────┤
│  本地文件系统存储 (SQLite可选)              │
└─────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  DeepSeek API    │    Moonshot API          │
│  (deepseek-chat) │    (kimi-k2.5等)         │
└─────────────────────────────────────────────┘
```

### 3.2 功能模块

#### M1: 基础对话系统
| 功能 | 描述 | 存储格式 |
|------|------|----------|
| 单轮对话 | 用户输入→AI回复 | - |
| 多轮对话 | 保持上下文连续 | `sessions/{id}/messages.jsonl` |
| 流式输出 | AI回复逐字显示 | - |
| 对话中断 | 可停止生成 | - |

#### M2: 会话管理
| 功能 | 描述 | 存储格式 |
|------|------|----------|
| 新建会话 | 创建空白对话 | `sessions/index.json` |
| 重命名会话 | 修改会话标题 | `sessions/index.json` |
| 删除会话 | 删除会话及历史 | 删除文件夹 |
| 会话列表 | 显示所有会话 | `sessions/index.json` |

**文件结构示例：**
```
data/
├── config.json              # 应用配置（主题、API密钥等）
├── sessions/
│   ├── index.json           # 会话索引
│   ├── 2024-01-01-abc123/
│   │   ├── messages.jsonl   # 对话记录
│   │   └── metadata.json    # 会话元数据
│   └── 2024-01-02-def456/
│       ├── messages.jsonl
│       └── metadata.json
└── knowledge/               # 知识库（未来扩展）
```

#### M3: 对话搜索
| 功能 | 描述 | 实现方式 |
|------|------|----------|
| 全文搜索 | 搜索所有对话内容 | 内存索引 + JSON遍历 |
| 结果高亮 | 关键词高亮显示 | 前端高亮 |
| 跳转定位 | 点击跳转到具体位置 | 会话ID + 消息ID |

#### M4: 文件分析
| 功能 | 支持格式 | 处理方式 |
|------|----------|----------|
| 上传文件 | PDF, DOC, DOCX, TXT, MD | 提取文本 → 传给AI |
| 拖拽上传 | 同上 | 同上 |
| 图片分析 | PNG, JPG, JPEG | 支持Vision模型 |
| 文件预览 | 文本文件 | 内置预览器 |

**存储格式：**
- 原始文件保存在 `uploads/{session_id}/`
- 提取的文本保存为 `{filename}.extracted.md`

#### M5: AI浏览器控制 ⭐核心特色功能
| 功能 | 描述 | 技术方案 |
|------|------|----------|
| 自然语言指令 | "帮我在淘宝搜索iPhone 16" | AI解析意图 |
| 浏览器驱动 | 自动打开、点击、输入 | Puppeteer / Playwright |
| 进度展示 | 实时显示操作步骤 | 右侧助手面板 |
| 结果提取 | 提取网页内容返回 | DOM解析 |
| 安全限制 | 仅允许特定域名/操作 | 白名单机制 |

**使用场景示例：**
```
用户：查查京东iPhone 16的价格
AI：正在打开京东...
    正在搜索"iPhone 16"...
    找到3个结果，价格区间：5999-8999元
```

#### M6: 界面与主题
| 功能 | 描述 | 存储格式 |
|------|------|----------|
| 三栏布局 | 左(会话)-中(对话)-右(助手) | - |
| 深色模式 | 暗色主题 | `config.json` |
| 浅色模式 | 亮色主题 | `config.json` |
| 自动跟随 | 跟随系统主题 | `config.json` |

#### M7: 导出功能
| 功能 | 格式 | 说明 |
|------|------|------|
| 导出对话 | Markdown | 保留格式和代码块 |
| 导出对话 | PDF | 带样式打印版 |
| 批量导出 | ZIP | 多个会话打包 |

#### M8: 智能助手面板（右侧栏）
| 区域 | 功能 |
|------|------|
| 顶部 | 当前模型选择（DeepSeek/Moonshot） |
| 中部 | 任务状态区（浏览器操作进度） |
| 下部 | 快捷指令按钮（清空对话、新建会话等） |
| 底部 | 设置入口、主题切换 |

### 3.3 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  🟢 Double                              [模型▼] [设置] [—] [□] [×]  │
├──────────┬──────────────────────────────────────┬───────────────────┤
│          │                                      │  🤖 智能助手      │
│  💬 会话  │   对话区域                            │  ───────────────  │
│  ───────  │                                      │                   │
│          │   ┌─────────────────────────────┐    │  模型: DeepSeek   │
│ 🔍 搜索   │   │ 你好！有什么可以帮你的？     │    │  [Kimi ▼]        │
│          │   └─────────────────────────────┘    │                   │
│ 会话1    │                                      │  ┌─────────────┐  │
│ 会话2    │   ┌─────────────────────────────┐    │  │ 📊 当前任务  │  │
│ 会话3    │   │ 我想查查淘宝上的iPhone价格   │    │  │ 打开淘宝...  │  │
│          │   └─────────────────────────────┘    │  │ 搜索中 ▶     │  │
│ + 新会话  │                                      │  └─────────────┘  │
│          │   ┌─────────────────────────────┐    │                   │
│          │   │ 🔍 正在打开淘宝搜索...       │    │  ━━━━━━━━━━━━━━  │
│          │   │ 找到5个结果，价格5999起...   │    │                   │
│          │   │ [截图预览]                   │    │  ⚡ 快捷指令      │
│          │   └─────────────────────────────┘    │  [新会话] [导出]  │
│          │                                      │  [清空] [搜索]    │
│          │   ┌─────────────────────────────┐    │                   │
│          │   │ 📎 输入消息...      [🎤] [↑]│    │  ━━━━━━━━━━━━━━  │
│          │   └─────────────────────────────┘    │                   │
│          │                                      │  🌙 [深色模式]    │
└──────────┴──────────────────────────────────────┴───────────────────┘
```

### 3.4 数据存储规范

#### 3.4.1 config.json (应用配置)
```json
{
  "version": "1.0.0",
  "theme": "auto | light | dark",
  "models": {
    "deepseek": {
      "enabled": true,
      "apiKey": "sk-xxx",
      "defaultModel": "deepseek-chat",
      "baseUrl": "https://api.deepseek.com"
    },
    "moonshot": {
      "enabled": true,
      "apiKey": "sk-xxx",
      "defaultModel": "kimi-k2.5",
      "baseUrl": "https://api.moonshot.cn"
    }
  },
  "defaultModel": "deepseek",
  "browser": {
    "enabled": true,
    "headless": false,
    "allowedDomains": ["taobao.com", "jd.com", "zhihu.com"]
  }
}
```

#### 3.4.2 sessions/index.json (会话索引)
```json
{
  "sessions": [
    {
      "id": "2024-01-15-abc123",
      "title": "淘宝iPhone价格查询",
      "createdAt": "2024-01-15T10:30:00Z",
      "updatedAt": "2024-01-15T11:00:00Z",
      "messageCount": 12,
      "model": "deepseek-chat"
    }
  ]
}
```

#### 3.4.3 messages.jsonl (对话记录)
```jsonl
{"id": "msg-001", "role": "user", "content": "你好", "timestamp": "2024-01-15T10:30:00Z", "type": "text"}
{"id": "msg-002", "role": "assistant", "content": "你好！有什么可以帮你的？", "timestamp": "2024-01-15T10:30:05Z", "type": "text"}
{"id": "msg-003", "role": "user", "content": "分析这个文件", "timestamp": "2024-01-15T10:31:00Z", "type": "file", "attachments": [{"name": "document.pdf", "path": "uploads/xxx/document.pdf"}]}
```

### 3.5 开发阶段

#### Phase 1: MVP核心功能 (2周)
- [ ] 基础Electron框架 + 三栏布局
- [ ] DeepSeek/Moonshot API接入
- [ ] 对话功能（发送/接收/流式）
- [ ] 会话管理（新建/重命名/删除）
- [ ] 本地数据存储（JSON/JSONL）

#### Phase 2: 增强功能 (2周)
- [ ] 文件上传分析（PDF/Word/图片）
- [ ] 对话历史持久化
- [ ] 对话搜索
- [ ] 深色/浅色主题
- [ ] 导出Markdown/PDF

#### Phase 3: 特色功能 (2周)
- [ ] AI浏览器控制（Puppeteer集成）
- [ ] 智能助手面板完善
- [ ] 拖拽文件上传
- [ ] 设置面板（API配置、主题等）

#### Phase 4: 优化与发布 (1周)
- [ ] 性能优化
- [ ] Bug修复
- [ ] 打包发布（Windows/Mac/Linux）

---

## 4. 技术要求

### 4.1 技术栈
- **框架**: Electron 28+
- **前端**: HTML/CSS/JS (或Vue 3)
- **后端**: Node.js (Electron主进程)
- **浏览器控制**: Puppeteer / Playwright
- **文件处理**: pdf-parse, mammoth, sharp

### 4.2 数据安全
- API密钥本地加密存储（electron-safe-storage）
- 对话数据不传输到第三方
- 浏览器控制白名单限制

### 4.3 性能要求
- 启动时间 < 3秒
- 对话响应 < 1秒（首字）
- 支持1000+条对话历史流畅滚动

---

## 5. 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| API限额/费用 | 高 | 提供本地缓存，提醒用户配额 |
| Puppeteer兼容性 | 中 | 提供降级方案（仅文本模式） |
| 文件解析失败 | 低 | 友好的错误提示，支持更多格式 |

---

## 6. 附录

### 6.1 API参考
- DeepSeek: https://platform.deepseek.com/docs
- Moonshot: https://platform.moonshot.cn/docs

### 6.2 命名规范
- 会话ID: `{YYYYMMDD}-{随机6位}`
- 消息ID: `msg-{时间戳}-{随机4位}`
- 文件命名: `{原始名}-{随机4位}.{扩展名}`

### 6.3 版本历史
- v0.1 - PRD初版 - 2024-02-24
